Queries
-------

https://www.raisin.nl/kennisbank/rendement-berekenen/

-- 1. Haal op de totale waarde per jaar. --
SELECT `year`, SUM(`value`) AS `value`
FROM (
   SELECT YEAR(tva.`date`) AS `year`, SUM(`value`) AS `value`
   FROM tbl_value_accounts tva
   LEFT JOIN tbl_accounts ON tva.`aid` = tbl_accounts.`id`
   WHERE tva.`date` IN (
       SELECT MIN(`date`)
       FROM tbl_value_accounts
       GROUP BY YEAR(`date`)
   )
   AND `type` IN ("finance","stock","savings")
   GROUP BY YEAR(tva.`date`)
   UNION
   SELECT YEAR(tvc.`date`) AS `year`, SUM(`amount`*`value`) AS `value`
   FROM tbl_value_cryptos tvc
   LEFT JOIN tbl_amount_wallets ON tvc.`id` = tbl_amount_wallets.`vid`
   LEFT JOIN tbl_wallets ON tbl_amount_wallets.`wid` = tbl_wallets.`id`
   LEFT JOIN tbl_accounts ON tbl_wallets.`aid` = tbl_accounts.`id`
   WHERE tvc.`date` IN (
       SELECT MIN(`date`)
       FROM tbl_value_cryptos
       GROUP BY YEAR(`date`)
   )
   AND `type` IN ("crypto")
   GROUP BY YEAR(tvc.`date`)
) total
GROUP BY `year`

-- Versie 2, met aid/wid en type
SELECT `year`, `value`, `awid`, `type`
FROM (
   SELECT YEAR(tva.`date`) AS `year`, SUM(`value`) AS `value`, CONCAT(`aid`,"_","0") AS `awid`, `type`
   FROM tbl_value_accounts tva
   LEFT JOIN tbl_accounts ON tva.`aid` = tbl_accounts.`id`
   WHERE tva.`date` IN (
       SELECT MIN(`date`)
       FROM tbl_value_accounts
       GROUP BY YEAR(`date`)
   )
   GROUP BY `year`, `aid`
   UNION
   SELECT YEAR(tvc.`date`) AS `year`, SUM(`amount`*`value`) AS `value`, CONCAT(`aid`,"_",`wid`) AS `awid`, `type`
   FROM tbl_value_cryptos tvc
   RIGHT JOIN tbl_amount_wallets ON tvc.`id` = tbl_amount_wallets.`vid`
   LEFT JOIN tbl_wallets ON tbl_amount_wallets.`wid` = tbl_wallets.`id`
   LEFT JOIN tbl_accounts ON tbl_wallets.`aid` = tbl_accounts.`id`
   WHERE tvc.`date` IN (
       SELECT MIN(`date`)
       FROM tbl_value_cryptos
       GROUP BY YEAR(`date`)
   ) -- AND `wid` IS NOT NULL
   GROUP BY `year`, `aid`, `wid`
) total
ORDER BY `year`, `awid`, `type`

-- 2. Haal de totale groei/krimp per jaar van financiën, beleggen, sparen en crypto. --
-- Versie 1
SELECT `year`, SUM(`value`) AS `value`
FROM (
    SELECT YEAR(tfin.`date`) AS `year`, SUM(IFNULL(`income`,0)) - SUM(IFNULL(`fixed`,0)) - SUM(IFNULL(`other`,0)) AS `value`
    FROM tbl_finances tfin
    LEFT JOIN tbl_accounts ON tfin.`aid` = tbl_accounts.`id`
    GROUP BY YEAR(tfin.`date`)
    UNION
    SELECT YEAR(tstk.`date`) AS `year`, SUM(IFNULL(`deposit`,0)) - SUM(IFNULL(`withdrawal`,0)) AS `value`
    FROM tbl_stocks tstk
    LEFT JOIN tbl_accounts ON tstk.`aid` = tbl_accounts.`id`
    GROUP BY YEAR(tstk.`date`)
    UNION
    SELECT YEAR(tsav.`date`) AS `year`, SUM(IFNULL(`deposit`,0)) - SUM(IFNULL(`withdrawal`,0)) AS `value`
    FROM tbl_savings tsav
    LEFT JOIN tbl_accounts ON tsav.`aid` = tbl_accounts.`id`
    GROUP BY YEAR(tsav.`date`)
    UNION
    SELECT YEAR(tcrp.`date`) AS `year`, SUM(IFNULL(`deposit`,0)) - SUM(IFNULL(`withdrawal`,0)) AS `value`
    FROM tbl_crypto tcrp
    LEFT JOIN tbl_amount_wallets ON tcrp.`id` = tbl_amount_wallets.`vid`
    LEFT JOIN tbl_wallets ON tbl_amount_wallets.`wid` = tbl_wallets.`id`
    LEFT JOIN tbl_accounts ON tbl_wallets.`aid` = tbl_accounts.`id`
    GROUP BY YEAR(tcrp.`date`)
) total
GROUP BY `year`

-- Versie 2, bepaal met PHP welke types (finance, stock, savings, crypto) worden getoond. 
SELECT `year`, SUM(`value`) AS `value`
FROM (
    SELECT YEAR(`date`) AS `year`, SUM(IFNULL(`income`,0)) - SUM(IFNULL(`fixed`,0)) - SUM(IFNULL(`other`,0)) AS `value`
    FROM tbl_finances
    GROUP BY YEAR(`date`)
    UNION
    SELECT YEAR(`date`) AS `year`, SUM(IFNULL(`deposit`,0)) - SUM(IFNULL(`withdrawal`,0)) AS `value`
    FROM tbl_stocks
    GROUP BY YEAR(`date`)
    UNION
    SELECT YEAR(`date`) AS `year`, SUM(IFNULL(`deposit`,0)) - SUM(IFNULL(`withdrawal`,0)) AS `value`
    FROM tbl_savings
    GROUP BY YEAR(`date`)
    UNION
    SELECT YEAR(`date`) AS `year`, SUM(IFNULL(`deposit`,0)) - SUM(IFNULL(`withdrawal`,0)) AS `value`
    FROM tbl_crypto
    GROUP BY YEAR(`date`)
) total
GROUP BY `year`

Versie 3, met aid/wid en type
SELECT `year`, `value`, `awid`, `type`
FROM (
    SELECT YEAR(tbl_finances.`date`) AS `year`, SUM(IFNULL(`income`,0)) - SUM(IFNULL(`fixed`,0)) - SUM(IFNULL(`other`,0)) AS `value`, CONCAT(`aid`,"_","0") AS `awid`, `type`
	FROM tbl_finances
    LEFT JOIN tbl_accounts ON tbl_finances.`aid` = tbl_accounts.`id`
	GROUP BY YEAR(tbl_finances.`date`), `aid`
	UNION
    SELECT YEAR(tbl_stocks.`date`) AS `year`, SUM(IFNULL(`deposit`,0)) - SUM(IFNULL(`withdrawal`,0)) AS `value`, CONCAT(`aid`,"_","0")  AS `awid`, `type`
	FROM tbl_stocks
    LEFT JOIN tbl_accounts ON tbl_stocks.`aid` = tbl_accounts.`id`
	GROUP BY YEAR(tbl_stocks.`date`), `aid`
	UNION
    SELECT YEAR(tbl_savings.`date`) AS `year`, SUM(IFNULL(`deposit`,0)) - SUM(IFNULL(`withdrawal`,0)) AS `value`, CONCAT(`aid`,"_","0")  AS `awid`, `type`
	FROM tbl_savings
    LEFT JOIN tbl_accounts ON tbl_savings.`aid` = tbl_accounts.`id`
	GROUP BY YEAR(tbl_savings.`date`), `aid`
    UNION
    SELECT YEAR(tbl_crypto.`date`) AS `year`, SUM(IFNULL(`deposit`,0)) - SUM(IFNULL(`withdrawal`,0)) AS `value`, CONCAT(`aid`,"_",`wid`) AS `awid`, `type`
	FROM tbl_crypto
    LEFT JOIN tbl_wallets ON tbl_crypto.`wid` = tbl_wallets.`id`
    LEFT JOIN tbl_accounts ON tbl_wallets.`aid` = tbl_accounts.`id`
	GROUP BY YEAR(tbl_crypto.`date`), `aid`, `wid`    
) total
ORDER BY `year`, `awid`


-- 1 en 2 gecombineerd.
SELECT B.`year`, A.`value` AS `gains`, B.`value` AS `trade`, B.`awid`, B.`type`
FROM (
   SELECT `year`, `value`, `awid`, `type`
   FROM (
      SELECT YEAR(tva.`date`) AS `year`, SUM(`value`) AS `value`, CONCAT(`aid`,"_","0") AS `awid`, `type`
      FROM tbl_value_accounts tva
      LEFT JOIN tbl_accounts ON tva.`aid` = tbl_accounts.`id`
      WHERE tva.`date` IN (
         SELECT MIN(`date`)
         FROM tbl_value_accounts
         GROUP BY YEAR(`date`)
      )
      GROUP BY `year`, `aid`
      UNION
      SELECT YEAR(tvc.`date`) AS `year`, SUM(`amount`*`value`) AS `value`, CONCAT(`aid`,"_",`wid`) AS `awid`, `type`
      FROM tbl_value_cryptos tvc
      RIGHT JOIN tbl_amount_wallets ON tvc.`id` = tbl_amount_wallets.`vid`
      LEFT JOIN tbl_wallets ON tbl_amount_wallets.`wid` = tbl_wallets.`id`
      LEFT JOIN tbl_accounts ON tbl_wallets.`aid` = tbl_accounts.`id`
      WHERE tvc.`date` IN (
         SELECT MIN(`date`)
         FROM tbl_value_cryptos
         GROUP BY YEAR(`date`)
      )
      GROUP BY `year`, `aid`, `wid`
   ) total_a
) A
JOIN (
   SELECT `year`, `value`, `awid`, `type`
   FROM (
      SELECT YEAR(tbl_finances.`date`) AS `year`, SUM(IFNULL(`income`,0)) - SUM(IFNULL(`fixed`,0)) - SUM(IFNULL(`other`,0)) AS `value`, CONCAT(`aid`,"_","0") AS `awid`, `type`
	  FROM tbl_finances
      LEFT JOIN tbl_accounts ON tbl_finances.`aid` = tbl_accounts.`id`
	  GROUP BY YEAR(tbl_finances.`date`), `aid`
	  UNION
      SELECT YEAR(tbl_stocks.`date`) AS `year`, SUM(IFNULL(`deposit`,0)) - SUM(IFNULL(`withdrawal`,0)) AS `value`, CONCAT(`aid`,"_","0")  AS `awid`, `type`
	  FROM tbl_stocks
      LEFT JOIN tbl_accounts ON tbl_stocks.`aid` = tbl_accounts.`id`
	  GROUP BY YEAR(tbl_stocks.`date`), `aid`
	  UNION
      SELECT YEAR(tbl_savings.`date`) AS `year`, SUM(IFNULL(`deposit`,0)) - SUM(IFNULL(`withdrawal`,0)) AS `value`, CONCAT(`aid`,"_","0")  AS `awid`, `type`
	  FROM tbl_savings
      LEFT JOIN tbl_accounts ON tbl_savings.`aid` = tbl_accounts.`id`
	  GROUP BY YEAR(tbl_savings.`date`), `aid`
      UNION
      SELECT YEAR(tbl_crypto.`date`) AS `year`, SUM(IFNULL(`deposit`,0)) - SUM(IFNULL(`withdrawal`,0)) AS `value`, CONCAT(`aid`,"_",`wid`) AS `awid`, `type`
	  FROM tbl_crypto
      LEFT JOIN tbl_wallets ON tbl_crypto.`wid` = tbl_wallets.`id`
      LEFT JOIN tbl_accounts ON tbl_wallets.`aid` = tbl_accounts.`id`
	  GROUP BY YEAR(tbl_crypto.`date`), `aid`, `wid`    
   ) total_b
) B
ON A.`year` = B.`year` AND A.`awid` = B.`awid`
ORDER BY `year`, `awid` -- , `type`


-- 3. Bereken met deze gegeven het jaarlijkse rendement. --
-- 4. Doe hetzelfde maar dan per onderdeel (beleggen, sparen en crypto (financiën?). Wat is het jaarlijkse rendement van een onderdeel. --
-- 5. De onderdelen kunnen verder per rekening worden opgesplitst. Wat is het jaarlijkse rendement van een rekening. --



-- Klad --
-- Get the first date of every year
SET @k = 'Put your encryption key or phrase here!';
SELECT tbl_value_accounts.id, 
       tbl_value_accounts.`date`,
       CAST(AES_DECRYPT(tbl_accounts.`account`, @k) AS CHAR(45)) AS `account`, 
       tbl_value_accounts.`value` 
FROM tbl_value_accounts
LEFT JOIN tbl_accounts ON tbl_value_accounts.aid = tbl_accounts.id
WHERE tbl_value_accounts.aid = 1 AND MONTH(tbl_value_accounts.`date`) = 1

-- With help from Co-Pilot
SELECT *
FROM tbl_value_accounts va
WHERE `date` IN (
    SELECT MIN(`date`)
    FROM tbl_value_accounts
    GROUP BY YEAR(`date`)
) AND va.aid = 1
ORDER BY `date`;

SELECT YEAR(va.`date`) AS `year`, SUM(`value`) AS total
FROM tbl_value_accounts va
WHERE `date` IN (
    SELECT MIN(`date`)
    FROM tbl_value_accounts
    GROUP BY YEAR(`date`)
) AND va.aid = 1
GROUP BY YEAR(`date`)
-- ORDER BY `date`;

SELECT tva.id, tva.`date`, tva.`value`
FROM (
    SELECT *, YEAR(`date`) AS `year`
    FROM tbl_value_accounts
) tva
JOIN (
    SELECT YEAR(`date`) AS `year`, MIN(`date`) AS first_date
    FROM tbl_value_accounts
    GROUP BY YEAR(`date`)
) every_year
ON tva.`year` = every_year.`year` AND tva.`date` = every_year.first_date
WHERE tva.aid = 1
ORDER BY tva.`year`;

-- Get the total values per year
SELECT YEAR(`date`) AS `year`, SUM(IFNULL(`deposit`,0)) - SUM(IFNULL(`withdrawal`,0)) AS total
FROM tbl_stocks
WHERE aid = 1
GROUP BY YEAR(`date`)


https://dev.mysql.com/doc/connector-odbc/en/connector-odbc-usagenotes-functionality-last-insert-id.html